# è„†å¼±æ€§èª¿æŸ»ã‚·ã‚¹ãƒ†ãƒ  ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

Slackã‹ã‚‰è„†å¼±æ€§èª¿æŸ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã€AWS Bedrock Agentsã‚’æ´»ç”¨ã—ã¦è‡ªå‹•èª¿æŸ»ã‚’è¡Œã†ã‚·ã‚¹ãƒ†ãƒ ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Slack  â”‚â”€â”€â”€â”€â”€â–¶â”‚  Lambda          â”‚â”€â”€â”€â”€â”€â–¶â”‚  Bedrock Agent  â”‚â”€â”€â”€â”€â”€â–¶â”‚  Action Groups   â”‚
â”‚  App    â”‚â—€â”€â”€â”€â”€â”€â”‚  (Event Handler) â”‚â—€â”€â”€â”€â”€â”€â”‚  (Agent
core)    â”‚â—€â”€â”€â”€â”€â”€â”‚  (èª¿æŸ»ãƒ„ãƒ¼ãƒ«)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚                                                    â”‚
                         â–¼                                                    â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚  Parameter Store â”‚                              â”‚  å¤–éƒ¨API         â”‚
                 â”‚  (Secrets)       â”‚                              â”‚  - NVD/CVE DB    â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚  - GitHub Advisoryâ”‚
                                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. ã‚³ã‚¹ãƒˆæœ€é©åŒ–æ–¹é‡

| é …ç›® | é¸å®š | ç†ç”± |
|------|------|------|
| API Gateway | **ä¸ä½¿ç”¨** | Lambda Function URL ã§ä»£æ›¿ï¼ˆç„¡æ–™ï¼‰ |
| NAT Gateway | **ä¸ä½¿ç”¨** | æœˆé¡ $32+ å›é¿ã€ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆæ§‹æˆ |
| Secrets Manager | **ä¸ä½¿ç”¨** | Parameter Store SecureString ã§ä»£æ›¿ï¼ˆç„¡æ–™æ å†…ï¼‰ |
| Lambda Runtime | **Node.js 22.x ARM64** | Graviton2ã§20%ã‚³ã‚¹ãƒˆå‰Šæ¸› |
| Bedrock Model | **Claude 3 Haiku** | ä½ã‚³ã‚¹ãƒˆãƒ»é«˜é€Ÿ |
| CloudWatch Logs | **7æ—¥ä¿æŒ** | é•·æœŸä¿å­˜ä¸è¦ãªãƒ­ã‚°ã¯çŸ­æœŸä¿æŒ |

### æœˆé¡ã‚³ã‚¹ãƒˆæ¦‚ç®—ï¼ˆ100ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ—¥ï¼‰

| ã‚µãƒ¼ãƒ“ã‚¹ | æ¦‚ç®—ã‚³ã‚¹ãƒˆ |
|----------|-----------|
| Lambda | ~$0.50 |
| Bedrock (Haiku) | ~$3.00 |
| Parameter Store | $0 (ç„¡æ–™æ ) |
| CloudWatch | ~$1.00 |
| **åˆè¨ˆ** | **~$5/æœˆ** |

## 3. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°

### 3.1 Slack App

```yaml
display_information:
  name: VulnScanner
  description: è„†å¼±æ€§èª¿æŸ»Bot

features:
  bot_user:
    display_name: VulnScanner
    always_online: true
  slash_commands:
    - command: /vuln
      url: https://<lambda-function-url>
      description: è„†å¼±æ€§ã‚’èª¿æŸ»
      usage_hint: "[CVE-ID or ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å]"

oauth_config:
  scopes:
    bot:
      - commands
      - chat:write
      - chat:write.public

settings:
  interactivity:
    is_enabled: true
    request_url: https://<lambda-function-url>
```

### 3.2 Lambda (Event Handler)

**è¨­å®š:**
- Runtime: `nodejs22.x`
- Architecture: `arm64`
- Memory: `256MB`
- Timeout: `30s`
- Function URL: æœ‰åŠ¹ï¼ˆAuth Type: NONEã€Slackç½²åã§æ¤œè¨¼ï¼‰

**IAM Policy (æœ€å°æ¨©é™):**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["bedrock:InvokeAgent"],
      "Resource": "arn:aws:bedrock:*:*:agent-alias/*/*"
    },
    {
      "Effect": "Allow",
      "Action": ["ssm:GetParameter"],
      "Resource": "arn:aws:ssm:*:*:parameter/vuln-scanner/*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:*:*:log-group:/aws/lambda/vuln-scanner*"
    }
  ]
}
```

### 3.3 Bedrock Agent

**è¨­å®š:**
- Foundation Model: `anthropic.claude-3-haiku-20240307-v1:0`
- Idle Session TTL: `600s`

**Instruction:**
```
ã‚ãªãŸã¯è„†å¼±æ€§èª¿æŸ»ã®å°‚é–€å®¶ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å•ã„åˆã‚ã›ã«å¯¾ã—ã¦ã€
ä»¥ä¸‹ã®æ‰‹é †ã§èª¿æŸ»ã‚’è¡Œã£ã¦ãã ã•ã„ï¼š

1. CVE-IDãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆï¼šNVD APIã§è©³ç´°ã‚’å–å¾—
2. ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆï¼šæ—¢çŸ¥ã®è„†å¼±æ€§ã‚’æ¤œç´¢
3. èª¿æŸ»çµæœã‚’æ—¥æœ¬èªã§ç°¡æ½”ã«ã¾ã¨ã‚ã‚‹

å›ç­”ã«ã¯ä»¥ä¸‹ã‚’å«ã‚ã¦ãã ã•ã„ï¼š
- è„†å¼±æ€§ã®æ¦‚è¦
- å½±éŸ¿åº¦ï¼ˆCVSSï¼‰
- å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³
- æ¨å¥¨ã•ã‚Œã‚‹å¯¾ç­–
```

**Action Groups:**

| Action Group | æ©Ÿèƒ½ | Lambdaè¨­å®š |
|-------------|------|-----------|
| `search-cve` | CVEè©³ç´°æ¤œç´¢ (NVD API) | 128MB, 15s |
| `search-package` | ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è„†å¼±æ€§æ¤œç´¢ (OSV API) | 128MB, 15s |
| `get-advisory` | GitHub Advisoryå–å¾— | 128MB, 15s |

## 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 4.1 èªè¨¼ãƒ•ãƒ­ãƒ¼

```
Slack User
    â”‚
    â”‚ 1. /vuln CVE-2024-1234
    â–¼
Lambda Function URL
    â”‚
    â”‚ 2. X-Slack-Signature æ¤œè¨¼
    â”‚ 3. ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ¤œè¨¼ (ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒé˜²æ­¢)
    â”‚ 4. è¨±å¯ãƒãƒ£ãƒ³ãƒãƒ«ç¢ºèª
    â–¼
Bedrock Agent (IAMèªè¨¼)
```

### 4.2 Slackç½²åæ¤œè¨¼

```typescript
import { createHmac, timingSafeEqual } from "crypto";

export const verifySlackSignature = (
  signingSecret: string,
  signature: string,
  timestamp: string,
  body: string
): boolean => {
  // ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒé˜²æ­¢ï¼ˆ5åˆ†ä»¥å†…ï¼‰
  const now = Math.floor(Date.now() / 1000);
  if (Math.abs(now - parseInt(timestamp)) > 300) {
    return false;
  }

  const sigBasestring = `v0:${timestamp}:${body}`;
  const mySignature = `v0=${createHmac("sha256", signingSecret)
    .update(sigBasestring)
    .digest("hex")}`;

  return timingSafeEqual(
    Buffer.from(mySignature),
    Buffer.from(signature)
  );
};
```

### 4.3 ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†

**Parameter Store:**
```
/vuln-scanner/
â”œâ”€â”€ slack-signing-secret    # Slackç½²åæ¤œè¨¼ç”¨
â”œâ”€â”€ slack-bot-token         # Bot Token (xoxb-...)
â””â”€â”€ github-token            # GitHub API Token (optional)
```

### 4.4 å…¥åŠ›æ¤œè¨¼

```typescript
const CVE_PATTERN = /^CVE-\d{4}-\d{4,}$/i;
const PACKAGE_PATTERN = /^(@[a-z0-9-~][a-z0-9-._~]*\/)?[a-z0-9-~][a-z0-9-._~]*$/;

export const validateInput = (input: string) => {
  const trimmed = input.trim();

  if (CVE_PATTERN.test(trimmed)) {
    return { type: "cve", value: trimmed.toUpperCase() };
  }
  if (PACKAGE_PATTERN.test(trimmed)) {
    return { type: "package", value: trimmed };
  }
  return { type: "invalid", value: null };
};
```

## 5. ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

```
â”Œâ”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Slackâ”‚          â”‚Lambda  â”‚         â”‚Bedrock  â”‚        â”‚Action Groupâ”‚
â””â”€â”€â”¬â”€â”€â”˜          â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
   â”‚                 â”‚                   â”‚                   â”‚
   â”‚ /vuln CVE-2024-1234                 â”‚                   â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚                   â”‚
   â”‚                 â”‚ ç½²åæ¤œè¨¼          â”‚                   â”‚
   â”‚ 200 OK (å³æ™‚)   â”‚                   â”‚                   â”‚
   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                   â”‚
   â”‚                 â”‚ InvokeAgent       â”‚                   â”‚
   â”‚                 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
   â”‚                 â”‚                   â”‚ search-cve        â”‚
   â”‚                 â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚                 â”‚                   â”‚                   â”‚â”€â”€â–¶ NVD API
   â”‚                 â”‚                   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
   â”‚ chat.postMessageâ”‚                   â”‚                   â”‚
   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                   â”‚
```

## 6. Terraformæ§‹æˆ

```hcl
# Lambda Function
resource "aws_lambda_function" "handler" {
  function_name = "vuln-scanner-handler"
  runtime       = "nodejs22.x"
  architectures = ["arm64"]
  handler       = "index.handler"
  memory_size   = 256
  timeout       = 30

  environment {
    variables = {
      BEDROCK_AGENT_ID       = aws_bedrockagent_agent.main.id
      BEDROCK_AGENT_ALIAS_ID = aws_bedrockagent_agent_alias.main.id
    }
  }
}

# Function URL (API Gatewayä»£æ›¿ãƒ»ç„¡æ–™)
resource "aws_lambda_function_url" "handler" {
  function_name      = aws_lambda_function.handler.function_name
  authorization_type = "NONE"
}

# Bedrock Agent
resource "aws_bedrockagent_agent" "main" {
  agent_name                  = "vuln-scanner"
  foundation_model            = "anthropic.claude-3-haiku-20240307-v1:0"
  instruction                 = file("${path.module}/agent-instruction.txt")
  idle_session_ttl_in_seconds = 600
}

# Parameter Store
resource "aws_ssm_parameter" "slack_signing_secret" {
  name  = "/vuln-scanner/slack-signing-secret"
  type  = "SecureString"
  value = var.slack_signing_secret
}

# CloudWatch Logs (7æ—¥ä¿æŒ)
resource "aws_cloudwatch_log_group" "handler" {
  name              = "/aws/lambda/vuln-scanner-handler"
  retention_in_days = 7
}
```

## 7. ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

```bash
# 1. Parameter Storeã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®š
aws ssm put-parameter \
  --name "/vuln-scanner/slack-signing-secret" \
  --type "SecureString" \
  --value "<SIGNING_SECRET>"

aws ssm put-parameter \
  --name "/vuln-scanner/slack-bot-token" \
  --type "SecureString" \
  --value "<BOT_TOKEN>"

# 2. Terraformãƒ‡ãƒ—ãƒ­ã‚¤
cd app/iac/environments/dev
terraform init
terraform apply

# 3. Function URLã‚’Slack Appã«è¨­å®š
```

## 8. ä½¿ç”¨ä¾‹

```
/vuln CVE-2024-1234

ğŸ” è„†å¼±æ€§èª¿æŸ»çµæœ: CVE-2024-1234

ğŸ“‹ æ¦‚è¦: Node.js ã® HTTP/2 å®Ÿè£…ã«ãŠã‘ã‚‹
   ã‚µãƒ¼ãƒ“ã‚¹æ‹’å¦è„†å¼±æ€§

âš ï¸ å½±éŸ¿åº¦: HIGH (CVSS: 7.5)

ğŸ“¦ å½±éŸ¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³:
   - Node.js < 18.19.1
   - Node.js < 20.11.1

âœ… æ¨å¥¨å¯¾ç­–: æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¸ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
```

## 9. ã‚³ã‚¹ãƒˆç›£è¦–

```hcl
resource "aws_budgets_budget" "vuln_scanner" {
  name         = "vuln-scanner-monthly"
  budget_type  = "COST"
  limit_amount = "10"
  limit_unit   = "USD"
  time_unit    = "MONTHLY"

  notification {
    comparison_operator        = "GREATER_THAN"
    threshold                  = 80
    threshold_type             = "PERCENTAGE"
    notification_type          = "ACTUAL"
    subscriber_email_addresses = [var.alert_email]
  }
}
```
